var extendStatics=function(a,c){return extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(a,c){a.__proto__=c}||function(a,c){for(var b in c)Object.prototype.hasOwnProperty.call(c,b)&&(a[b]=c[b])},extendStatics(a,c)};function __extends(a,c){function b(){this.constructor=a}if("function"!=typeof c&&null!==c)throw new TypeError("Class extends value "+(c+"")+" is not a constructor or null");extendStatics(a,c),a.prototype=null===c?Object.create(c):(b.prototype=c.prototype,new b)}var __assign=function(){return __assign=Object.assign||function(a){for(var b,c=1,d=arguments.length;c<d;c++)for(var e in b=arguments[c],b)Object.prototype.hasOwnProperty.call(b,e)&&(a[e]=b[e]);return a},__assign.apply(this,arguments)};function __awaiter(a,b,c,d){function e(a){return a instanceof c?a:new c(function(b){b(a)})}return new(c||(c=Promise))(function(c,f){function g(a){try{i(d.next(a))}catch(a){f(a)}}function h(a){try{i(d["throw"](a))}catch(a){f(a)}}function i(a){a.done?c(a.value):e(a.value).then(g,h)}i((d=d.apply(a,b||[])).next())})}function __generator(a,b){function c(a){return function(b){return d([a,b])}}function d(c){if(e)throw new TypeError("Generator is already executing.");for(;k;)try{if(e=1,h&&(i=2&c[0]?h["return"]:c[0]?h["throw"]||((i=h["return"])&&i.call(h),0):h.next)&&!(i=i.call(h,c[1])).done)return i;switch((h=0,i)&&(c=[2&c[0],i.value]),c[0]){case 0:case 1:i=c;break;case 4:return k.label++,{value:c[1],done:!1};case 5:k.label++,h=c[1],c=[0];continue;case 7:c=k.ops.pop(),k.trys.pop();continue;default:if((i=k.trys,!(i=0<i.length&&i[i.length-1]))&&(6===c[0]||2===c[0])){k=0;continue}if(3===c[0]&&(!i||c[1]>i[0]&&c[1]<i[3])){k.label=c[1];break}if(6===c[0]&&k.label<i[1]){k.label=i[1],i=c;break}if(i&&k.label<i[2]){k.label=i[2],k.ops.push(c);break}i[2]&&k.ops.pop(),k.trys.pop();continue;}c=b.call(a,k)}catch(a){c=[6,a],h=0}finally{e=i=0}if(5&c[0])throw c[1];return{value:c[0]?c[1]:void 0,done:!0}}var e,h,i,j,k={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]};return j={next:c(0),throw:c(1),return:c(2)},"function"==typeof Symbol&&(j[Symbol.iterator]=function(){return this}),j}var FPUser=function(){function a(){this.key=Date.now()+"",this.attrs={}}return a.prototype.with=function(a,b){return this.attrs[a]=b,this},a.prototype.getKey=function(){return this.key},a.prototype.getAttrs=function(){return Object.assign({},this.attrs)},a.prototype.extendAttrs=function(a){for(var b in a)this.attrs[b]=a[b];return this},a.prototype.get=function(a){return this.attrs[a]},a.prototype.stableRollout=function(a){return this.key=a,this},a}();function E(){}E.prototype={on:function(a,b,c){var d=this.e||(this.e={});return(d[a]||(d[a]=[])).push({fn:b,ctx:c}),this},once:function(a,b,c){function d(){e.off(a,d),b.apply(c,arguments)}var e=this;return d._=b,this.on(a,d,c)},emit:function(a){var b=[].slice.call(arguments,1),c=((this.e||(this.e={}))[a]||[]).slice(),d=0,e=c.length;for(d;d<e;d++)c[d].fn.apply(c[d].ctx,b);return this},off:function(a,b){var c=this.e||(this.e={}),d=c[a],e=[];if(d&&b)for(var f=0,g=d.length;f<g;f++)d[f].fn!==b&&d[f].fn._!==b&&e.push(d[f]);return e.length?c[a]=e:delete c[a],this}};var tinyEmitter=E,TinyEmitter=E;tinyEmitter.TinyEmitter=TinyEmitter;const version="3.7.2",VERSION="3.7.2",_hasatob="function"==typeof atob,_hasbtoa="function"==typeof btoa,_hasBuffer="function"==typeof Buffer,_TD="function"==typeof TextDecoder?new TextDecoder:void 0,_TE="function"==typeof TextEncoder?new TextEncoder:void 0,b64ch="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",b64chs=Array.prototype.slice.call(b64ch),b64tab=(b=>{let a={};return b.forEach((b,c)=>a[b]=c),a})(b64chs),b64re=/^(?:[A-Za-z\d+\/]{4})*?(?:[A-Za-z\d+\/]{2}(?:==)?|[A-Za-z\d+\/]{3}=?)?$/,_fromCC=String.fromCharCode.bind(String),_U8Afrom="function"==typeof Uint8Array.from?Uint8Array.from.bind(Uint8Array):(a,b=a=>a)=>new Uint8Array(Array.prototype.slice.call(a,0).map(b)),_mkUriSafe=a=>a.replace(/=/g,"").replace(/[+\/]/g,a=>"+"==a?"-":"_"),_tidyB64=a=>a.replace(/[^A-Za-z0-9\+\/]/g,""),btoaPolyfill=a=>{let b,c,d,e,f="";const g=a.length%3;for(let g=0;g<a.length;){if(255<(c=a.charCodeAt(g++))||255<(d=a.charCodeAt(g++))||255<(e=a.charCodeAt(g++)))throw new TypeError("invalid character found");b=c<<16|d<<8|e,f+=b64chs[63&b>>18]+b64chs[63&b>>12]+b64chs[63&b>>6]+b64chs[63&b]}return g?f.slice(0,g-3)+"===".substring(g):f},_btoa=_hasbtoa?a=>btoa(a):_hasBuffer?a=>Buffer.from(a,"binary").toString("base64"):btoaPolyfill,_fromUint8Array=_hasBuffer?a=>Buffer.from(a).toString("base64"):a=>{const b=4096;let c=[];for(let d=0,e=a.length;d<e;d+=b)c.push(_fromCC.apply(null,a.subarray(d,d+b)));return _btoa(c.join(""))},fromUint8Array=(a,b=!1)=>b?_mkUriSafe(_fromUint8Array(a)):_fromUint8Array(a),cb_utob=a=>{if(2>a.length){var b=a.charCodeAt(0);return 128>b?a:2048>b?_fromCC(192|b>>>6)+_fromCC(128|63&b):_fromCC(224|15&b>>>12)+_fromCC(128|63&b>>>6)+_fromCC(128|63&b)}var b=65536+1024*(a.charCodeAt(0)-55296)+(a.charCodeAt(1)-56320);return _fromCC(240|7&b>>>18)+_fromCC(128|63&b>>>12)+_fromCC(128|63&b>>>6)+_fromCC(128|63&b)},re_utob=/[\uD800-\uDBFF][\uDC00-\uDFFFF]|[^\x00-\x7F]/g,utob=a=>a.replace(re_utob,cb_utob),_encode=_hasBuffer?a=>Buffer.from(a,"utf8").toString("base64"):_TE?a=>_fromUint8Array(_TE.encode(a)):a=>_btoa(utob(a)),encode=(a,b=!1)=>b?_mkUriSafe(_encode(a)):_encode(a),encodeURI=a=>encode(a,!0),re_btou=/[\xC0-\xDF][\x80-\xBF]|[\xE0-\xEF][\x80-\xBF]{2}|[\xF0-\xF7][\x80-\xBF]{3}/g,cb_btou=a=>{switch(a.length){case 4:var b=(7&a.charCodeAt(0))<<18|(63&a.charCodeAt(1))<<12|(63&a.charCodeAt(2))<<6|63&a.charCodeAt(3),c=b-65536;return _fromCC((c>>>10)+55296)+_fromCC((1023&c)+56320);case 3:return _fromCC((15&a.charCodeAt(0))<<12|(63&a.charCodeAt(1))<<6|63&a.charCodeAt(2));default:return _fromCC((31&a.charCodeAt(0))<<6|63&a.charCodeAt(1));}},btou=a=>a.replace(re_btou,cb_btou),atobPolyfill=a=>{if(a=a.replace(/\s+/g,""),!b64re.test(a))throw new TypeError("malformed base64.");a+="==".slice(2-(3&a.length));let b,c,d,e="";for(let f=0;f<a.length;)b=b64tab[a.charAt(f++)]<<18|b64tab[a.charAt(f++)]<<12|(c=b64tab[a.charAt(f++)])<<6|(d=b64tab[a.charAt(f++)]),e+=64===c?_fromCC(255&b>>16):64===d?_fromCC(255&b>>16,255&b>>8):_fromCC(255&b>>16,255&b>>8,255&b);return e},_atob=_hasatob?a=>atob(_tidyB64(a)):_hasBuffer?a=>Buffer.from(a,"base64").toString("binary"):atobPolyfill,_toUint8Array=_hasBuffer?b=>_U8Afrom(Buffer.from(b,"base64")):b=>_U8Afrom(_atob(b),a=>a.charCodeAt(0)),toUint8Array=b=>_toUint8Array(_unURI(b)),_decode=_hasBuffer?b=>Buffer.from(b,"base64").toString("utf8"):_TD?b=>_TD.decode(_toUint8Array(b)):b=>btou(_atob(b)),_unURI=b=>_tidyB64(b.replace(/[-_]/g,a=>"-"==a?"+":"/")),decode=a=>_decode(_unURI(a)),isValid=a=>{if("string"!=typeof a)return!1;const b=a.replace(/\s+/g,"").replace(/={0,2}$/,"");return!/[^\s0-9a-zA-Z\+/]/.test(b)||!/[^\s0-9a-zA-Z\-_]/.test(b)},_noEnum=a=>({value:a,enumerable:!1,writable:!0,configurable:!0}),extendString=function(){const a=(a,b)=>Object.defineProperty(String.prototype,a,_noEnum(b));a("fromBase64",function(){return decode(this)}),a("toBase64",function(a){return encode(this,a)}),a("toBase64URI",function(){return encode(this,!0)}),a("toBase64URL",function(){return encode(this,!0)}),a("toUint8Array",function(){return toUint8Array(this)})},extendUint8Array=function(){const a=(a,b)=>Object.defineProperty(Uint8Array.prototype,a,_noEnum(b));a("toBase64",function(a){return fromUint8Array(this,a)}),a("toBase64URI",function(){return fromUint8Array(this,!0)}),a("toBase64URL",function(){return fromUint8Array(this,!0)})},extendBuiltins=()=>{extendString(),extendUint8Array()},gBase64={version:"3.7.2",VERSION:VERSION,atob:_atob,atobPolyfill:atobPolyfill,btoa:_btoa,btoaPolyfill:btoaPolyfill,fromBase64:decode,toBase64:encode,encode:encode,encodeURI:encodeURI,encodeURL:encodeURI,utob:utob,btou:btou,decode:decode,isValid:isValid,fromUint8Array:fromUint8Array,toUint8Array:toUint8Array,extendString:extendString,extendUint8Array:extendUint8Array,extendBuiltins:extendBuiltins};var commonjsGlobal="undefined"==typeof globalThis?"undefined"==typeof window?"undefined"==typeof global?"undefined"==typeof self?{}:self:global:window:globalThis;function createCommonjsModule(a,b){return b={exports:{}},a(b,b.exports),b.exports}var wefetch_min=createCommonjsModule(function(a,b){!function(b,c){a.exports=c()}(commonjsGlobal,function(){function b(){this.listeners={}}function d(a){return function(b){(b=b||{}).config=b.config||{};for(var c=arguments.length,d=Array(1<c?c-1:0),e=1;e<c;e++)d[e-1]=arguments[e];return new Promise(function(c,e){b.config.eventType?l.emit(b.config.eventType,a.apply(void 0,[Object.assign({},b,{success:c,fail:e})].concat(d))):a.apply(void 0,[Object.assign({},b,{success:c,fail:e})].concat(d))})}}function e(){this.platform=null,this.api=null}function g(a,b){return function(){for(var c=Array(arguments.length),d=0,e=c.length;d<e;d++)c[d]=arguments[d];return a.apply(b,c)}}function j(){this.handles=[]}function a(a){return f.normalizeHeaderName(a.header||a.headers),"download"===a.method&&(a.method="get",a.createRequest=i.getDownload()),"upload"===a.method&&(a.method="post",a.createRequest=i.getUpload()),(0,a.createRequest)(a).then(function(a){return a},function(a){return Promise.reject(a)})}function c(a){this.defaults=a,this.before=new j,this.after=new j}function k(a){var b=new c(a),d=g(c.prototype.request,b);return f.extends(d,c.prototype,b),f.extends(d,b),d}b.prototype.on=function(a,b){a in this.listeners||(this.listeners[a]=[]),this.listeners[a].push(b)},b.prototype.emit=function(a,b){var c=this.listeners[a];c&&c.forEach(function(a){a(b)})};var l=new b;e.prototype.getRequest=function(){return"undefined"==typeof wx?"undefined"==typeof my?"undefined"==typeof tt?"undefined"==typeof swan?void 0:(this.api=swan,this.platform="swan",d(swan.request)):(this.api=tt,this.platform="tt",d(tt.request)):(this.platform="my",this.api=my,my.request?d(my.request):d(my.httpRequest)):(this.platform="wx",this.api=wx,d(wx.request))},e.prototype.getUpload=function(){return d(this.api.uploadFile)},e.prototype.getDownload=function(){return d(this.api.downloadFile)};var i=new e,m={createRequest:i.getRequest(),header:{},config:{},method:"get",timeout:0},n=Object.prototype.toString,f={type:function(){for(var a={},b=["String","Object","Number","Array","Undefined","Function","Null","Date"],c=0,d=b.length;c<d;c++)!function(b){a["is"+b]=function(a){return n.call(a)==="[object "+b+"]"}}(b[c]);return a}(),normalizeHeaderName:function(a){for(var b in a)/Content-Type/gi.test(b)&&(a["Content-Type"]=a[b],delete a[b])},forEach:function(a,b){if(a)if("object"!=typeof a&&(a=[a]),this.type.isArray(a))for(var c=0,d=a.length;c<d;c++)b.call(null,a[c],c,a);else for(var f in a)Object.prototype.hasOwnProperty.call(a,f)&&b.call(null,a[f],f,a)},merge:function(){function a(a,c){b[c]="object"==typeof b[c]&&"object"==typeof a?f.merge(b[c],a):a}for(var b={},c=0,d=arguments.length;c<d;c++)this.forEach(arguments[c],a);return b},deepMerge:function(){function a(a,c){b[c]="object"==typeof b[c]&&"object"==typeof a?f.deepMerge(b[c],a):"object"==typeof a?f.deepMerge({},a):a}for(var b={},c=0,d=arguments.length;c<d;c++)this.forEach(arguments[c],a);return b},mergeConfig:function(a,b){var c={};return b=b||{},["url","method","data","config"].forEach(function(a){b[a]&&(c[a]=b[a])}),["header","headers"].forEach(function(d){f.type.isObject(b[d])?c[d]=f.deepMerge(a[d],b[d]):b[d]?c[d]=b[d]:f.type.isObject(a[d])?c[d]=f.deepMerge(a[d]):a[d]&&(c[d]=a[d])}),["baseUrl","timeout","eventType","createRequest"].forEach(function(d){void 0===b[d]?void 0!==a[d]&&(c[d]=a[d]):c[d]=b[d]}),c},extends:function(a,b,c){return this.forEach(b,function(b,d){a[d]=c&&"function"==typeof b?g(b,c):b}),a}};j.prototype.use=function(a,b){return this.handles.push({fulfilled:a,rejected:b}),this.handles.length-1},j.prototype.eject=function(a){this.handles[a]&&(this.handles[a]=null)},j.prototype.forEach=function(a){this.handles.forEach(function(b){b&&a(b)})},["options","get","head","post","put","delete","trace","connect"].forEach(function(a){c.prototype[a]=function(b,c){return this.request(f.merge(c||{},{url:b,method:a}))}}),c.prototype.download=function(a,b){return f.type.isObject(a)?this.request(f.merge(a,{method:"download"})):this.request(f.merge(b||{},{url:a,method:"download"}))},c.prototype.upload=function(a,b){return f.type.isObject(a)?this.request(a,{method:"upload"}):this.request(f.merge(b||{},{url:a,method:"upload"}))},c.prototype.on=function(a,b){l.on(a,b)},c.prototype.abort=function(a,b){this.on(a,function(a){a.abort(),b&&b()})},c.prototype.onProcess=function(a,b){this.on(a,function(a){a.onProgressUpdate(b)})},c.prototype.promisify=d,c.prototype.request=function(b){"string"==typeof b&&((b=arguments[1]||{}).url=arguments[0]),-1===(b=f.mergeConfig(this.defaults,b)).url.indexOf("http")&&(b.downloadUrl&&"download"===b.method?b.url=b.downloadUrl+b.url:b.uploadUrl&&"upload"===b.method?b.url=b.uploadUrl+b.url:b.url=b.baseUrl+b.url),"my"===i.platform&&"download"!==b.method&&"upload"!==b.method&&(b.headers=Object.assign({},b.header),delete b.header);var c=[a,void 0],d=Promise.resolve(b);for(this.before.forEach(function(a){c.unshift(a.fulfilled,a.rejected)}),this.after.forEach(function(a){c.push(a.fulfilled,a.rejected)});c.length;)d=d.then(c.shift(),c.shift());return d},Promise.prototype.finally=Promise.prototype.finally||function(a){var b=this.constructor;return this.then(function(c){b.resolve(a(c)).then(function(){return c})},function(c){b.resolve(a(c)).then(function(){return Promise.reject(c)})})};var o=k(m);return o.all=function(a){return Promise.all(a)},o.retry=function d(a,b,c){if(c=c||1e3,!a&&0!==a||!b)throw new Error("request and times params is required");if("function"!=typeof b)throw new Error("request must be a function, but got a\n"+typeof b);var f=b();return 1<a?(a--,new Promise(function(g,e){f.then(g).catch(function(){setTimeout(function(){g(d(a,b,c))},c)})})):f},o.create=function(a){return k(f.merge(m,a))},o})}),wefetch=wefetch_min,PKG_VERSION="1.0.1",UA="WECHAT_MINIPROGRAM/"+PKG_VERSION,EVENTS={READY:"ready",ERROR:"error",TOGGLES:"toggles"},FeatureProbe=function(a){function b(){var b=a.call(this)||this;return b.togglesUrl="",b.eventsUrl="",b.user=new FPUser,b.clientSdkKey="",b.refreshInterval=0,b.toggles={},b}return __extends(b,a),b.prototype.init=function(a){var b=a.remoteUrl,c=a.togglesUrl,d=a.eventsUrl,e=a.clientSdkKey,f=a.user,g=a.refreshInterval,h=void 0===g?1e3:g;if(!e)throw new Error("clientSdkKey is required");if(0>=h)throw new Error("refreshInterval is invalid");if(!b&&!c)throw new Error("remoteUrl or togglesUrl is required");if(!b&&!d)throw new Error("remoteUrl or eventsUrl is required");if(!b&&!c&&!d)throw new Error("remoteUrl is required");this.togglesUrl=c||b+"/api/client-sdk/toggles",this.eventsUrl=d||b+"/api/events",this.user=f,this.clientSdkKey=e,this.refreshInterval=h},b.prototype.start=function(){return __awaiter(this,void 0,void 0,function(){var a,b=this;return __generator(this,function(c){switch(c.label){case 0:return a=this.refreshInterval,[4,this.fetchToggles()];case 1:return c.sent(),this.emit(EVENTS.READY),this.timer=setInterval(function(){return b.fetchToggles()},a),[2];}})})},b.prototype.stop=function(){clearInterval(this.timer)},b.prototype.boolValue=function(a,b){return this.toggleValue(a,b,"boolean")},b.prototype.numberValue=function(a,b){return this.toggleValue(a,b,"number")},b.prototype.stringValue=function(a,b){return this.toggleValue(a,b,"string")},b.prototype.jsonValue=function(a,b){return this.toggleValue(a,b,"object")},b.prototype.boolDetail=function(a,b){return this.toggleDetail(a,b,"boolean")},b.prototype.numberDetail=function(a,b){return this.toggleDetail(a,b,"number")},b.prototype.stringDetail=function(a,b){return this.toggleDetail(a,b,"string")},b.prototype.jsonDetail=function(a,b){return this.toggleDetail(a,b,"object")},b.prototype.allToggles=function(){return Object.assign({},this.toggles)},b.prototype.getUser=function(){return Object.assign({},this.user)},b.newForTest=function(a){var c=new b;return c.init({remoteUrl:"http://127.0.0.1:4000",clientSdkKey:"_",user:new FPUser}),c.toggles=a,c},b.prototype.toggleValue=function(a,b,c){if(this.sendEvents(a),null==this.toggles)return b;var d=this.toggles[a];if(void 0===d)return b;var e=d.value;return typeof e==c?e:b},b.prototype.toggleDetail=function(a,b,c){if(this.sendEvents(a),null==this.toggles)return{value:b,ruleIndex:null,variationIndex:null,version:0,reason:"Not ready"};var d=this.toggles[a];return void 0===d?{value:b,ruleIndex:null,variationIndex:null,version:null,reason:"Toggle: ["+a+"] not found"}:typeof d.value===c?d:{value:b,ruleIndex:null,variationIndex:null,version:null,reason:"Value type mismatch"}},b.prototype.fetchToggles=function(){return __awaiter(this,void 0,void 0,function(){var a,b,c,d=this;return __generator(this,function(e){switch(e.label){case 0:return a=JSON.stringify(this.user),b=gBase64.encode(a),c=this.togglesUrl,[4,wefetch.get(c,{cache:"no-cache",header:{Authorization:this.clientSdkKey,"Content-Type":"application/json",UA:UA},data:{user:b}}).then(function(a){d.toggles=a.data,d.emit(EVENTS.TOGGLES)}).catch(function(a){d.emit(EVENTS.ERROR,a)})];case 1:return e.sent(),[2];}})})},b.prototype.sendEvents=function(a){return __awaiter(this,void 0,void 0,function(){var b,c,d;return __generator(this,function(e){switch(e.label){case 0:return this.toggles&&this.toggles[a]?(b=Date.now(),c=[{access:{startTime:b,endTime:b,counters:(d={},d[a]=[{count:1,value:this.toggles[a].value,index:this.toggles[a].variationIndex,version:this.toggles[a].version}],d)}}],[4,wefetch.post(this.eventsUrl,{cache:"no-cache",header:{Authorization:this.clientSdkKey,"Content-Type":"application/json",UA:UA},data:JSON.stringify(c)}).catch(function(){})]):[3,2];case 1:e.sent(),e.label=2;case 2:return[2];}})})},b}(TinyEmitter),featureProbeClient=new FeatureProbe;featureProbeClient.on("toggles",function(){getApp().globalData.toggles=featureProbeClient.allToggles()});var originalApp=App;App=function(a){return void 0===a&&(a={}),a.globalData=__assign(__assign({},a.globalData),{toggles:featureProbeClient.allToggles()}),originalApp(a)};export{FPUser,featureProbeClient};
